name: Deploy to AWS EC2

on:
  workflow_run:
    workflows: ["RunTests"]    # Debe coincidir con el `name:` de tu RunTests.yml
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Solo si RunTests terminó OK y es sobre main
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract version from commit message
        id: extract_version
        run: |
          MSG="${{ github.event.workflow_run.head_commit.message }}"
          echo "🔍 Commit message: $MSG"
          # Regex que captura X.Y.Z y opcional -suffix (beta, rc, alpha, etc)
          VER=$(echo "$MSG" | grep -oE 'v?[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9\.]+)?' \
                  | head -n1 \
                  | sed 's/^v//')
          if [ -z "$VER" ]; then
            echo "::error::No se encontró versión en el mensaje del commit"
            exit 1
          fi
          echo "Versión encontrada: $VER"
          echo "version=$VER" >> $GITHUB_OUTPUT

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker image
        uses: docker/build-push-action@v3
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/miapp:${{ steps.extract_version.outputs.version }}
            ${{ secrets.DOCKERHUB_USERNAME }}/miapp:latest

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add EC2 host to known_hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy on EC2
        run: |
          ssh -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_HOST }} << 'EOF'
            # Detén y elimina la versión anterior
            docker stop miapp || true
            docker rm miapp   || true

            # Baja y arranca la nueva imagen
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/miapp:${{ steps.extract_version.outputs.version }}

            docker run -d \
              --name miapp \
              -p 80:8080 \
              -e SPRING_DATASOURCE_URL=jdbc:mysql://${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}/${{ secrets.DB_NAME }} \
              -e SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USER }} \
              -e SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }} \
              ${{ secrets.DOCKERHUB_USERNAME }}/miapp:${{ steps.extract_version.outputs.version }}
          EOF
